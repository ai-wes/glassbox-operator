services:
  operator:
    build: ./apps/operator
    environment:
      - OPERATOR_PORT=8090
      - OPERATOR_HOST=0.0.0.0
      # Optional auth. If set, requires: Authorization: Bearer <token>
      # - OPERATOR_API_KEY=replace_me
      # Point to upstreams JSON (mounted below)
      - OPERATOR_UPSTREAMS_PATH=/config/upstreams.json
      - OPERATOR_ACTION_MAP_PATH=/config/actionmap.json
      - OPERATOR_ALLOW_WRITE=0
      - NEO4J_ENABLED=1
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=please_change_me
      - NEO4J_DATABASE=neo4j
    ports:
      - "8090:8090"
    volumes:
      - ./operator.upstreams.example.json:/config/upstreams.json:ro
      - ./operator.actionmap.example.json:/config/actionmap.json:ro
      - ./.data:/app/.data
    restart: unless-stopped

  glassbox_mcp:
    build: ./apps/glassbox-mcp
    environment:
      - GLASSBOX_MCP_PORT=8091
      - GLASSBOX_MCP_HOST=0.0.0.0
      # Your FastAPI base (set to your deployed API)
      - GLASSBOX_API_BASE_URL=https://api.glassbox-bio.com/api/v1
      # Auth options:
      # - GLASSBOX_BEARER_TOKEN=...
      # - GLASSBOX_INTERNAL_API_KEY=...
    ports:
      - "8091:8091"
    restart: unless-stopped

  neo4j:
    image: neo4j:5
    environment:
      - NEO4J_AUTH=neo4j/please_change_me
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    healthcheck:
      test: ["CMD-SHELL", "/var/lib/neo4j/bin/cypher-shell -u neo4j -p please_change_me 'RETURN 1' >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - ./.data/neo4j/data:/data
      - ./.data/neo4j/logs:/logs
    restart: unless-stopped

  operator_mcp:
    build:
      context: ./apps2/operator-mcp
    environment:
      - OPERATOR_ACTOR_ID=wes
      - OPERATOR_DB_PATH=/data/operator.db
      - MAX_PERSIST_BYTES=200000
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=please_change_me
      - MCP_SERVERS_CONFIG=/config/mcp-servers.json
    volumes:
      - operator_mcp_data:/data
      - ./mcp-servers.json:/config/mcp-servers.json:ro
    depends_on:
      neo4j:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

volumes:
  operator_mcp_data:
